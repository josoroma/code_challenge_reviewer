

# code_challenge_reviewer - src/agents.py



## Project Name: code_challenge_reviewer

## Path: src/agents.py

## Explain This:
This file defines several classes to create and manage different types of agents, as well as a utility class for logging output to a Streamlit expander. The `Agents` class provides methods to create agents for code review, file path extraction, and fetching file content via GitHub API. The `StreamToExpander` class redirects log output to a Streamlit UI component, filtering out ANSI escape codes and handling task notifications.

## Code Review:
### Code Quality:
- The code is mostly well-structured and readable.
- Docstrings are provided for all functions, which is good for maintainability.
- The logging configuration is set to only log errors, which may not be sufficient for debugging purposes.

### Bugs:
- No immediate bugs are observed in the given code.

### Anti-Patterns:
- The use of `try-except` blocks is appropriate, but logging only errors might make debugging harder.
- The `StreamToExpander` class's `write` method appends cleaned data to a buffer and flushes it when a newline is detected. This could lead to high memory usage if the buffer is not flushed regularly.

### Improvements:
- Add logging for successful creation of agents to help with debugging.
- Consider adding more granular logging levels (INFO, DEBUG) for better insight into the application's behavior.
- Refactor the `write` method in the `StreamToExpander` class to handle large data streams more efficiently.
- Add type hints to the methods for better code clarity and type checking.
- Ensure that the `buffer` in `StreamToExpander` is periodically cleared to free memory.

### Compliance:
- The code follows PEP 8 standards for the most part.
- Add type hints for compliance with modern Python practices.

## Updated Code:
```python
import re
import logging
from crewai import Agent
import streamlit as st
from tools import Tools

# Set up logging configuration
logging.basicConfig(level=logging.DEBUG)

class Agents:
    """
    Class to create and manage different types of agents.
    """

    def review_agent(self) -> Agent:
        """
        Creates a review agent for code reviews.

        Returns:
            Agent: Configured agent for performing code reviews.
        """
        try:
            agent =  Agent(
                role='Senior Software Developer',
                goal='Perform detailed code reviews on the provided file to ensure it adheres to industry code quality standards. The code review should focus on the following aspects: evaluate code quality, identify bugs, spot anti-patterns, recommend improvements and ensure compliance.',
                backstory="You are a Senior Software Developer at a leading tech company, responsible for maintaining high code quality standards across the organization. As part of your role, you are tasked with conducting thorough code reviews on given file contents. Your goal is to ensure the code meets industry standards and follows best practices specific to the technologies in use.",
                allow_delegation=False,
                verbose=True,
            )
            logging.info("Review agent created successfully")
            return agent
        except Exception as e:
            logging.error(f"Error creating review agent: {e}")
            return None

    def path_agent(self) -> Agent:
        """
        Creates a path agent for extracting file paths.

        Returns:
            Agent: Configured agent for extracting file paths.
        """
        try:
            agent =  Agent(
                role="File Path Extractor",
                goal="Get the tree structure of folder and return full paths of the given file or files of given folder in array format",
                backstory="You're a file path extractor who has created several file paths from given tree structures",
                allow_delegation=False,
                verbose=True,
            )
            logging.info("Path agent created successfully")
            return agent
        except Exception as e:
            logging.error(f"Error creating path agent: {e}")
            return None

    def content_agent(self) -> Agent:
        """
        Creates a content agent for fetching file content using GitHub API.

        Returns:
            Agent: Configured agent for fetching file content using GitHub API.
        """
        try:
            agent =  Agent(
                role="GitHub API Expert",
                goal="Get the content of given file using GitHub API",
                backstory="You're a GitHub API expert who has extracted many file contents using GitHub's API",
                verbose=True,
                allow_delegation=False,
                tools=[Tools.get_file_contents],
            )
            logging.info("Content agent created successfully")
            return agent
        except Exception as e:
            logging.error(f"Error creating content agent: {e}")
            return None

class StreamToExpander:
    def __init__(self, expander: st.delta_generator.DeltaGenerator) -> None:
        self.expander = expander
        self.buffer = []
        self.colors = ['red', 'green', 'blue', 'orange']  # Define a list of colors
        self.color_index = 0  # Initialize color index

    def write(self, data: str) -> None:
        # Filter out ANSI escape codes using a regular expression
        cleaned_data = re.sub(r'\x1B\[[0-9;]*[mK]', '', data)

        # Check if the data contains 'task' information
        task_match_object = re.search(r'\"task\"\s*:\s*\"(.*?)\"', cleaned_data, re.IGNORECASE)
        task_match_input = re.search(r'task\s*:\s*([^\n]*)', cleaned_data, re.IGNORECASE)

        task_value = None

        if task_match_object:
            task_value = task_match_object.group(1)
        elif task_match_input:
            task_value = task_match_input.group(1).strip()

        if task_value:
            st.toast(":robot_face: " + task_value)

        self.buffer.append(cleaned_data)

        if "\n" in data:
            self.expander.code(''.join(self.buffer), language='bash')
            self.buffer = []

    def clear_buffer(self) -> None:
        """Clears the buffer to free memory."""
        self.buffer = []
```

This updated code improves logging for better debugging, adds type hints for better code clarity and type checking, and includes some minor refactoring for better memory management.

